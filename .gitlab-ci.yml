include:
  - project: 'iopsys/gitlab-ci-pipeline'
    file: '/static-code-analysis.yml'

stages:
    - static_code_analysis
    - unit_test
    - functional_test
    - functional_api_test
    - uspd

variables:
  DEBUG: 'TRUE'
  SOURCE_FOLDER: "."

run_unit_test:
  stage: unit_test
  image: iopsys/code-analysis-dev:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/unit-test.sh"
  artifacts:
    when: always
    paths:
      - timestamp.log
      - unit-test-coverage.xml

run_functional_test:
  stage: functional_test
  image: iopsys/code-analysis-dev:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/functional-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - functional-test-coverage.xml

run_functional_api_test:
  stage: functional_api_test
  image: iopsys/code-analysis-dev:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/functional-api-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - functional-api-test-coverage.xml

run_uspd:
  stage: uspd
  variables:
    UPSTREAM_BBF_SHA: $CI_COMMIT_SHA
    SOURCE_FOLDER: "src"
  allow_failure: false
  trigger:
    project: iopsys/uspd
    branch: bbf_pipeline
    strategy: depend
