include:
  - project: 'iopsys/gitlab-ci-pipeline'
    file: '/static-code-analysis.yml'

variables:
  DEBUG: 'TRUE'
  SOURCE_FOLDER: "."
  COMMON_IMAGE: iopsys/code-analysis:0.26
  RUN_CPPCHECK: "cppcheck --enable=style --error-exitcode=1 --inline-suppr --include=/usr/local/include/json-c/json_object.h --include=/usr/include/libubox/list.h -I . -I ./include/ -I ./libbbf_api/ -i test/ -DBBF_VENDOR_IOPSYS -DBBF_VENDOR_OPENWRT"

stages:
    - static_code_analysis
    - unit_test
    - functional_test
    - memory_test
    - uspd

run_unit_test:
  stage: unit_test
  image: iopsys/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/unit-test.sh"
  artifacts:
    when: always
    paths:
      - timestamp.log
      - unit-test-coverage.xml

run_functional_test:
  stage: functional_test
  image: iopsys/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/functional-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - functional-test-coverage.xml

run_functional_api_test:
  stage: functional_test
  image: iopsys/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/functional-api-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - functional-api-test-coverage.xml

run_tools_test:
  stage: unit_test
  image: iopsys/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/tools-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - tools/out/datamodel_default.xml
          - tools/out/datamodel_hdm.xml
          - tools/out/datamodel.xls

run_memory_test:
  stage: memory_test
  image: iopsys/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/memory-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - memory-test-coverage.xml
          - bbf_out.zip

doxygen:
  stage: unit_test
  image: iopsys/code-analysis:latest
  before_script:
      - apt update
      - apt --assume-yes install doxygen graphviz

  script:
    - doxygen Doxyfile
    - mv doxygen/html/ public/

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

run_uspd:
  stage: uspd
  inherit:
    variables: false
  variables:
    UPSTREAM_BBF_SHA: $CI_COMMIT_SHA
  allow_failure: false
  trigger:
    project: iopsys/uspd
    branch: bbf_pipeline
    strategy: depend
