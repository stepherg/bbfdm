include:
  - project: 'iopsys/gitlab-ci-pipeline'
    file: '/static-code-analysis.yml'

include:
  - project: 'docs/portal2/pipeline-template'
    file: 'MkDocs.gitlab-ci.yml'

variables:
  DEBUG: 'TRUE'
  SOURCE_FOLDER: "."
  COMMON_IMAGE: dev.iopsys.eu:5050/iopsys/gitlab-ci-pipeline/code-analysis:0.27
  RUN_CPPCHECK: "cppcheck --enable=information --error-exitcode=1 -DBBFDM_ENABLE_DOTSO_PLUGIN -DBBFDM_ENABLE_DOTSO_PLUGIN -DBBF_TR181 -DBBF_VENDOR_IOPSYS --inline-suppr -i test/"

stages:
    - static_code_analysis
    - unit_test
    - memory_test
    - functional_test
    - deploy

run_unit_test:
  stage: unit_test
  image: dev.iopsys.eu:5050/iopsys/gitlab-ci-pipeline/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/unit-test.sh"
  artifacts:
    when: always
    paths:
      - timestamp.log
      - unit-test-coverage.xml

run_functional_test:
  stage: functional_test
  image: dev.iopsys.eu:5050/iopsys/gitlab-ci-pipeline/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/functional-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - functional-test-coverage.xml

run_functional_api_test:
  stage: functional_test
  image: dev.iopsys.eu:5050/iopsys/gitlab-ci-pipeline/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/functional-api-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - functional-api-test-coverage.xml

run_tools_test:
  stage: unit_test
  image: iopsys/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/tools-test.sh"

  artifacts:
      when: always
      paths:
          - timestamp.log
          - tools/out/datamodel_default.xml
          - tools/out/datamodel_hdm.xml
          - tools/out/datamodel.xls

run_memory_test:
  stage: memory_test
  image: dev.iopsys.eu:5050/iopsys/gitlab-ci-pipeline/code-analysis:latest
  allow_failure: false
  script:
  - "./gitlab-ci/setup.sh"
  - "./gitlab-ci/memory-test.sh"
  artifacts:
      when: always
      paths:
          - timestamp.log
          - output-report-device-get.txt

doxygen:
  stage: unit_test
  image: dev.iopsys.eu:5050/iopsys/gitlab-ci-pipeline/code-analysis:latest
  before_script:
      - apt update
      - apt --assume-yes install doxygen graphviz

  script:
    - doxygen Doxyfile
    - mv doxygen/html/ public/

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

